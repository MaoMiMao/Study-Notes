## Java内存模型与线程

![1550711363076](F:\笔记\Java\虚拟机\1550711363076.png)

### 主内存与工作内存 

内存模型规定所有变量存储在主内存中 。每条线程有自己的工作内存用于保存被该线程使用到的变量的主内存副本拷贝，线程对变量的操作必须在工作内存中进行。线程间变量值传递通过主内存传递

### 内存间的交互操作(8种)

lock、unlock、read、write(main memory)

load、use、assign、store(worker memory)

操作规则

- read&load、store&write 不允许单独出现
- 工作内存改变了必须同步回主线程 即线程不能丢弃assign操作
- 不允许没有assign操作把数据从工作内存同步回主内存
- 新变量只能在主内存中诞生，不允许工作内存直接使用未被初始化的变量
- 一个变量同一时刻只允许一条线程进行lock操作、多次lock须执行相同次数的unlock
- 对一个变量执行lock操作，会清空工作内存中此变量的值
- 没有被lock的变量不允许进行unlock操作:也不允许unlock其他线程锁住的变量
- 对一个变量执行unlock操作，必须先把此变量同步到主内存

### volatile变量

缓存一致性

### 特性(原子性、可见性、有序性)

### 先行原则

操作A先于操作B 在操作B之前，操作A产生的影响都能被操作B观察到

关系推导如果不在此列则无法判断顺序性

![1549852565381](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1549852565381.png)

### 线程的实现

内核实现、使用用户线程、使用用户线程加轻量级进程混合实现

进程状态 

新建、运行、等待(有限&无限)、阻塞、结束

### 线程安全

当多个线程访问同一个对象时，如果不考虑这些线程在运行时环境下的调度和交替执行、也不需要进行额外的同步、或者调用方进行任何其他的协调操作、调用这个对象的行为都可以获得正确的结果、那这个对象就是线程安全的

数据共享分类: 不可变、绝对线程安全、相对线程安全、线程兼容、线程对立

实现方法  互斥同步、非阻塞同步、无同步方案(可重入代码、线程本地存储)

### 锁优化

自旋锁与自适应自旋、锁消除、锁粗化、轻量级锁、偏向锁

